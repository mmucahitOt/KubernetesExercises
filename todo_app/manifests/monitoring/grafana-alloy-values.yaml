# Grafana Alloy configuration for log collection
agent:
  # Enable DaemonSet mode to run on all nodes
  daemonset:
    enabled: true
  
  # Mount host directories for log collection
  volumes:
    - name: varlogpods
      hostPath:
        path: /var/log/pods
    - name: varlogcontainers
      hostPath:
        path: /var/log/containers
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: varlog
      hostPath:
        path: /var/log
    - name: run
      hostPath:
        path: /run
  
  volumeMounts:
    - name: varlogpods
      mountPath: /var/log/pods
      readOnly: true
    - name: varlogcontainers
      mountPath: /var/log/containers
      readOnly: true
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: run
      mountPath: /run
      readOnly: true
  
  # Security context to run as root (needed for log access)
  securityContext:
    runAsUser: 0
    runAsGroup: 0
    runAsNonRoot: false
  
  configMap:
    content: |
      // Discover all pods in the project namespace using Kubernetes API
      discovery.kubernetes "pods" {
        role = "pod"
        namespaces {
          names = ["project"]
        }
      }

      // Collect logs from all discovered pods using Kubernetes API
      loki.source.kubernetes "kubernetes_logs" {
        targets = discovery.kubernetes.pods.targets
        forward_to = [loki.process.kubernetes_logs.receiver]
      }

      // Process Kubernetes logs
      loki.process "kubernetes_logs" {
        forward_to = [loki.write.default.receiver]

        // Parse CRI log format
        stage.cri { }
        
        // Extract service name from JSON logs (Winston format) - must be before labels stage
        stage.json {
          expressions = {
            service_name = "service",
          }
        }
        
        // Extract labels from Kubernetes metadata and JSON content, add them to the log stream
        stage.labels {
          values = {
            namespace = "__meta_kubernetes_namespace",
            pod = "__meta_kubernetes_pod_name",
            container = "__meta_kubernetes_pod_container_name",
            node = "__meta_kubernetes_node_name",
            app = "__meta_kubernetes_pod_label_app",
            deployment = "__meta_kubernetes_pod_controller_name",
            service_name = "service_name",  // Use the extracted JSON value
          }
        }
      }

      // Write logs to Loki using full FQDN for better DNS resolution
      loki.write "default" {
        endpoint {
          url = "http://loki.project.svc.cluster.local:3100/loki/api/v1/push"
        }
        external_labels = {}
      }
