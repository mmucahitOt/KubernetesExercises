name: Exercises - Build and Push Docker Images

on:
  push:
    paths:
      - 'log_output/log_output/**'
      - 'log_output/read_output/**'
      - 'ping_pong/**'
    branches: [main, master]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to use (default: commit SHA)'
        required: false
        type: string

env:
  REGISTRY: docker.io
  IMAGE_TAG: ${{ github.event.inputs.image_tag || github.sha }}

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push log_output
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/log_output:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/log_output:latest \
            --push log_output/log_output

      - name: Build and push read_output
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/read_output:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/read_output:latest \
            --push log_output/read_output

      - name: Build and push ping_pong
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/ping_pong:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/ping_pong:latest \
            --push ping_pong

      - name: Build and push ping_pong_db
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/ping_pong_db:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/ping_pong_db:latest \
            --push ping_pong/database

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2.1.0

      - name: Configure Git
        run: |
          git config --local user.email "m.mucahit0@gmail.com"
          git config --local user.name "mmucahitOt"

      - name: Update Kustomize image tags
        working-directory: log_output/manifests
        run: |
          kustomize edit set image DOCKER_REGISTRY/log_output=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/log_output:${{ env.IMAGE_TAG }}
          kustomize edit set image DOCKER_REGISTRY/read_output=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/read_output:${{ env.IMAGE_TAG }}
          kustomize edit set image DOCKER_REGISTRY/ping_pong=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/ping_pong:${{ env.IMAGE_TAG }}
          kustomize edit set image DOCKER_REGISTRY/ping_pong_db=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/ping_pong_db:${{ env.IMAGE_TAG }}

      - name: Commit and push updated kustomization.yaml
        run: |
          git add log_output/manifests/kustomization.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update image tags to ${{ env.IMAGE_TAG }}"
            git push origin HEAD:main
          fi

