name: Project - Build and Push Docker Images

on:
  push:
    paths:
      - 'todo_app/todo_app/**'
      - 'todo_app/todo_app_backend/**'
      - 'todo_app/todo_app_backend_db/**'
      - 'todo_app/todo_app_add_job/**'
      - 'todo_app/todo_app_db_backup_cronjob/**'
      - 'todo_app/todo_app_broadcaster/**'
      - 'todo_app/todo_app_frontend/**'
    branches: [main, master]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to use (default: commit SHA or tag)'
        required: false
        type: string
      environment:
        description: 'Environment to update (staging or production)'
        required: false
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: docker.io
  IMAGE_TAG: ${{ github.event.inputs.image_tag || github.ref_type == 'tag' && github.ref_name || github.sha }}
  ENVIRONMENT: ${{ github.event.inputs.environment || (github.ref_type == 'tag' && 'production' || 'staging') }}

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: todo_app/todo_app_frontend/package-lock.json

      - name: Build Frontend
        working-directory: todo_app/todo_app_frontend
        run: |
          npm ci
          npm run build

      - name: Copy Frontend to Backend
        run: |
          mkdir -p todo_app/todo_app/public
          rm -rf todo_app/todo_app/public/*
          cp -R todo_app/todo_app_frontend/dist/. todo_app/todo_app/public/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push todo_app
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app:latest \
            --push todo_app/todo_app

      - name: Build and push todo_app_backend
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backend:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backend:latest \
            --push todo_app/todo_app_backend

      - name: Build and push todo_app_backend_db
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backend_db:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backend_db:latest \
            --push todo_app/todo_app_backend_db

      - name: Build and push todo_app_add_job
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_add_job:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_add_job:latest \
            --push todo_app/todo_app_add_job

      - name: Build and push todo_app_backup_job
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backup_job:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backup_job:latest \
            --push todo_app/todo_app_db_backup_cronjob

      - name: Build and push todo_app_broadcaster
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_broadcaster:${{ env.IMAGE_TAG }} \
            -t ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_broadcaster:latest \
            --push todo_app/todo_app_broadcaster

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2.1.0

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Update Kustomize image tags
        working-directory: todo_app/overlays/${{ env.ENVIRONMENT }}
        run: |
          kustomize edit set image TODO_APP_IMAGE/TAG=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app:${{ env.IMAGE_TAG }}
          kustomize edit set image TODO_APP_BACKEND_IMAGE/TAG=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backend:${{ env.IMAGE_TAG }}
          kustomize edit set image TODO_APP_BACKEND_DB_IMAGE/TAG=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backend_db:${{ env.IMAGE_TAG }}
          kustomize edit set image TODO_APP_ADD_JOB_IMAGE/TAG=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_add_job:${{ env.IMAGE_TAG }}
          kustomize edit set image TODO_APP_BACKUP_JOB_IMAGE/TAG=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_backup_job:${{ env.IMAGE_TAG }}
          kustomize edit set image TODO_APP_BROADCASTER_IMAGE/TAG=${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/todo_app_broadcaster:${{ env.IMAGE_TAG }}

      - name: Commit and push updated kustomization.yaml
        run: |
          git add todo_app/overlays/${{ env.ENVIRONMENT }}/kustomization.yaml
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update ${{ env.ENVIRONMENT }} image tags to ${{ env.IMAGE_TAG }}"
            if [ "${{ github.ref_type }}" = "tag" ]; then
              git push origin HEAD:refs/heads/main
            else
              git push origin HEAD:main
            fi
          fi

