# Grafana Alloy configuration for log collection
agent:
  # Enable DaemonSet mode to run on all nodes
  daemonset:
    enabled: true
  
  # Mount host directories for log collection
  volumes:
    - name: varlogpods
      hostPath:
        path: /var/log/pods
    - name: varlogcontainers
      hostPath:
        path: /var/log/containers
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: varlog
      hostPath:
        path: /var/log
    - name: run
      hostPath:
        path: /run
  
  volumeMounts:
    - name: varlogpods
      mountPath: /var/log/pods
      readOnly: true
    - name: varlogcontainers
      mountPath: /var/log/containers
      readOnly: true
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: run
      mountPath: /run
      readOnly: true
  
  # Security context to run as root (needed for log access)
  securityContext:
    runAsUser: 0
    runAsGroup: 0
    runAsNonRoot: false
  
  configMap:
    content: |
      // Collect logs from all pods in exercises namespace
      loki.source.kubernetes "kubernetes_logs" {
        forward_to = [loki.process.kubernetes_logs.receiver]
      }

      // Process Kubernetes logs
      loki.process "kubernetes_logs" {
        forward_to = [loki.write.default.receiver]

        stage.cri { }
        
        stage.labels {
          values = {
            namespace = "__meta_kubernetes_namespace",
            pod = "__meta_kubernetes_pod_name",
            container = "__meta_kubernetes_pod_container_name",
            node = "__meta_kubernetes_node_name",
          }
        }
      }

      loki.write "default" {
        endpoint {
          url = "http://loki:3100/loki/api/v1/push"
        }
        external_labels = {}
      }